---
import Layout from "../../layouts/Layout.astro";
import AuthPage from "../../components/auth/AuthPage.astro";
import { ResetPasswordForm } from "../../components/auth/ResetPasswordForm";
import { UpdatePasswordForm } from "../../components/auth/UpdatePasswordForm";
import { createSupabaseServerInstance } from "../../db/supabase.client";

// Check if there's a recovery code in the URL
const code = Astro.url.searchParams.get("code");
let hasRecoverySession = false;

if (code) {
  // If there's a code, exchange it for a session
  const supabase = createSupabaseServerInstance({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });

  const { error } = await supabase.auth.exchangeCodeForSession(code);

  if (!error) {
    hasRecoverySession = true;
  }
} else {
  // Check if user already has a session (shouldn't happen but just in case)
  const supabase = createSupabaseServerInstance({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });

  const {
    data: { user },
  } = await supabase.auth.getUser();
  hasRecoverySession = user !== null;
}

const highlights = [
  {
    title: "Bezpieczenstwo",
    description: "Link resetu działa krótko i jest jednorazowy.",
  },
  {
    title: "Wsparcie",
    description:
      "Nie zdradzamy, czy adres jest w bazie, aby chronić prywatność.",
  },
];
---

<Layout title="Reset hasła | 10xRules">
  {
    hasRecoverySession ? (
      <AuthPage
        eyebrow="Nowe hasło"
        title="Ustaw nowe hasło"
        description="Wprowadź nowe hasło dla swojego konta."
        note="Po zmianie hasła zostaniesz przekierowany do strony logowania."
        highlights={highlights}
      >
        <UpdatePasswordForm client:load />
      </AuthPage>
    ) : (
      <AuthPage
        eyebrow="Odzyskiwanie"
        title="Zresetuj swoje hasło"
        description="Podaj email powiązany z kontem, a wyślemy Ci instrukcje ustawienia nowego hasła."
        note="Jeśli wolisz, możesz założyć nowe konto korzystając z opcji rejestracji."
        highlights={highlights}
      >
        <ResetPasswordForm client:load />
      </AuthPage>
    )
  }
</Layout>
